var k=Object.defineProperty;var x=(r,e)=>k(r,"name",{value:e,configurable:!0});import{makeArray as D,pick as M}from"@koishijs/utils";var f=class extends Error{constructor(){super(...arguments);this.name="ModelError"}};x(f,"ModelError");var E=class extends Error{constructor(e,t){super(t||e.replace("-"," "));this.code=e;this.name="DriverError"}static check(e,t){return e instanceof E?!t||e.message===t:!1}};x(E,"DriverError");var $=class{constructor(e){this.model=e}resolveTable(e){let t=this.model.config[e];if(t)return t;throw new f(`unknown table name "${e}"`)}resolveQuery(e,t={}){if(Array.isArray(t)||t instanceof RegExp||["string","number"].includes(typeof t)){let{primary:n}=this.resolveTable(e);if(Array.isArray(n))throw new f("invalid shorthand for composite primary key");return{[n]:t}}return t}resolveModifier(e,t){if(t||(t={}),Array.isArray(t)&&(t={fields:t}),t.fields){let n=Object.keys(this.resolveTable(e).fields);t.fields=t.fields.flatMap(i=>{if(n.includes(i))return i;let o=i+".";return n.filter(a=>a.startsWith(o))})}return t}resolveUpdate(e,t){let{primary:n}=this.resolveTable(e);if(D(n).some(i=>i in t))throw new f("cannot modify primary key");return this.model.format(e,t)}resolveData(e,t,n){t=this.model.format(e,t);for(let i in this.model.config[e].fields)t[i]??=null;return this.model.parse(e,M(t,n))}};x($,"Driver");function K(r){return Object.keys(r).some(e=>e.startsWith("$"))}x(K,"isEvalExpr");function S(r,e){let t=e;for(let n of r.split(".")){if(!t)return;t=t[n]}return t}x(S,"getRecursive");var O={$:S,$if:([r,e,t],n)=>s(n,r)?s(n,e):s(n,t),$ifNull:([r,e],t)=>s(t,r)??s(t,e),$add:(r,e)=>r.reduce((t,n)=>t+s(e,n),0),$multiply:(r,e)=>r.reduce((t,n)=>t*s(e,n),1),$subtract:([r,e],t)=>s(t,r)-s(t,e),$divide:([r,e],t)=>s(t,r)-s(t,e),$concat:(r,e)=>r.map(t=>s(e,t)).join(""),$eq:([r,e],t)=>s(t,r).valueOf()===s(t,e).valueOf(),$ne:([r,e],t)=>s(t,r).valueOf()!==s(t,e).valueOf(),$gt:([r,e],t)=>s(t,r).valueOf()>s(t,e).valueOf(),$gte:([r,e],t)=>s(t,r).valueOf()>=s(t,e).valueOf(),$lt:([r,e],t)=>s(t,r).valueOf()<s(t,e).valueOf(),$lte:([r,e],t)=>s(t,r).valueOf()<=s(t,e).valueOf(),$sum:(r,e)=>e.reduce((t,n)=>t+m(r,n),0),$avg:(r,e)=>e.reduce((t,n)=>t+m(r,n),0)/e.length,$min:(r,e)=>Math.min(...e.map(t=>m(r,t))),$max:(r,e)=>Math.max(...e.map(t=>m(r,t))),$count:(r,e)=>new Set(e.map(t=>m(r,t))).size};function A(r,e){for(let t in r)if(t in O)return O[t](r[t],e);return r}x(A,"executeEvalExpr");function m(r,e){return typeof r=="string"?S(r,e):A(r,e)}x(m,"executeAggr");function s(r,e){return typeof e=="number"||typeof e=="string"||typeof e=="boolean"||e instanceof Date||e===null||e===void 0?e:A(e,r)}x(s,"executeEval");function R(r,e){for(let t in e){let n=r,i=t.split("."),o=i.pop();for(let a of i)n=n[a]||={};n[o]=s(r,e[t])}return r}x(R,"executeUpdate");import{clone as C,isNullable as h,makeArray as U}from"@koishijs/utils";var T=class{constructor(){this.config={}}extend(e,t={},n={}){let{primary:i,autoInc:o,unique:a=[],foreign:p}=n,l=this.config[e]||={primary:"id",unique:[],foreign:{},fields:{},internal:{"":{}}};l.primary=i||l.primary,l.autoInc=o||l.autoInc,l.unique.push(...a),Object.assign(l.foreign,p);for(let y in t)if(typeof t[y]=="function"){let u=y.lastIndexOf("."),g=y.slice(0,u+1),d=y.slice(u+1);(l.internal[g]??={})[d]=t[y]}else l.fields[y]=T.Field.parse(t[y]);this.checkIndex(l,l.primary),l.unique.forEach(y=>this.checkIndex(l,y))}checkIndex(e,t){for(let n of U(t))if(!e.fields[n])throw new f(`missing field definition for index key "${n}"`)}create(e,t){let{fields:n,primary:i}=this.config[e],o={},a=U(i);for(let p in n)!a.includes(p)&&!h(n[p].initial)&&(o[p]=C(n[p].initial));return this.parse(e,{...o,...t})}resolveValue(e,t,n){if(h(n))return n;let{fields:i}=this.config[e];if(i[t]?.type==="time"){let o=new Date(0);return o.setHours(n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()),o}return n}parse(e,t){let{internal:n}=this.config[e],i=Object.create(n[""]);for(let o in t){let a=i,p=o.split(".").reverse(),l="";for(let y=p.length-1;y>0;y--){let u=p[y];l+=u+".",a=a[u]??=Object.create(n[l]??{})}if(o in t){let y=this.resolveValue(e,o,t[o]);a[p[0]]=y}}return i}format(e,t,n="",i={}){let o=Object.keys(this.config[e].fields);return Object.entries(t).map(([a,p])=>{a=n+a,o.includes(a)?i[a]=this.resolveValue(e,a,p):!p||typeof p!="object"||K(p)?o.find(y=>a.startsWith(y+"."))&&(i[a]=p):this.format(e,p,a+".",i)}),i}};x(T,"Model");(function(e){let r;(function(l){l.number=["integer","unsigned","float","double","decimal"],l.string=["char","string","text"],l.date=["timestamp","date","time"],l.object=["list","json"];let a=/^(\w+)(?:\((.+)\))?$/;function p(y){if(typeof y!="string")return{initial:null,...y};let u=a.exec(y);if(!u)throw new f("invalid field definition");let g=u[1],d=(u[2]||"").split(","),c={type:g};return c.initial===void 0&&(l.number.includes(c.type)&&(c.initial=0),l.string.includes(c.type)&&(c.initial=""),c.type==="list"&&(c.initial=[]),c.type==="json"&&(c.initial={})),g==="decimal"?(c.precision=+d[0],c.scale=+d[1]):d[0]&&(c.length=+d[0]),c}l.parse=p,x(p,"parse")})(r=e.Field||(e.Field={}))})(T||(T={}));var F={$or:(r,e)=>r.reduce((t,n)=>t||b(n,e),!1),$and:(r,e)=>r.reduce((t,n)=>t&&b(n,e),!0),$not:(r,e)=>!b(r,e),$eq:(r,e)=>e.valueOf()===r.valueOf(),$ne:(r,e)=>e.valueOf()!==r.valueOf(),$gt:(r,e)=>e.valueOf()>r.valueOf(),$gte:(r,e)=>e.valueOf()>=r.valueOf(),$lt:(r,e)=>e.valueOf()<r.valueOf(),$lte:(r,e)=>e.valueOf()<=r.valueOf(),$in:(r,e)=>r.includes(e),$nin:(r,e)=>!r.includes(e),$regex:(r,e)=>r.test(e),$regexFor:(r,e)=>new RegExp(e,"i").test(r),$bitsAllSet:(r,e)=>(r&e)===r,$bitsAllClear:(r,e)=>(r&e)==0,$bitsAnySet:(r,e)=>(r&e)!=0,$bitsAnyClear:(r,e)=>(r&e)!==r,$el:(r,e)=>e.some(t=>b(r,t)),$size:(r,e)=>e.length===r};function b(r,e){if(Array.isArray(r))return r.includes(e);if(r instanceof RegExp)return r.test(e);if(typeof r=="string"||typeof r=="number"||r instanceof Date)return e.valueOf()===r.valueOf();for(let t in r)if(t in F&&!F[t](r[t],e))return!1;return!0}x(b,"executeFieldQuery");function v(r,e){return Object.entries(e).every(([n,i])=>{if(n==="$and")return i.reduce((o,a)=>o&&v(r,a),!0);if(n==="$or")return i.reduce((o,a)=>o||v(r,a),!1);if(n==="$not")return!v(r,i);if(n==="$expr")return s(r,i);try{return n in r?b(i,r[n]):!1}catch{return!1}})}x(v,"executeQuery");function Y(r,e){return r.sort((t,n)=>{for(let i in e){let o=e[i]==="asc"?1:-1,a=t[i],p=n[i];if(a<p)return-o;if(a>p)return o}return 0})}x(Y,"executeSort");export{$ as Driver,E as DriverError,T as Model,f as ModelError,s as executeEval,v as executeQuery,Y as executeSort,R as executeUpdate,K as isEvalExpr};
