var Ue=Object.defineProperty;var h=(l,e)=>Ue(l,"name",{value:e,configurable:!0});var ve=(l,e)=>()=>(e||l((e={exports:{}}).exports,e),e.exports);var Pe=ve((Cn,pt)=>{pt.exports={general:{name:"中文",paren:"（{0}）",quote:"“{0}”",comma:"，",and:"和",or:"或",day:"天",hour:"小时",minute:"分钟",second:"秒"},internal:{"low-authority":"权限不足。","insufficient-arguments":"缺少参数，输入帮助以查看用法。","redunant-arguments":"存在多余参数，输入帮助以查看用法。","invalid-argument":"参数 {0} 输入无效，{1}","unknown-option":"存在未知选项 {0}，输入帮助以查看用法。","invalid-option":"选项 {0} 输入无效，{1}","check-syntax":"输入帮助以查看用法。","invalid-number":"请提供一个数字。","invalid-integer":"请提供一个整数。","invalid-posint":"请提供一个正整数。","invalid-natural":"请提供一个非负整数。","invalid-date":"请输入合法的时间。","invalid-user":"请指定正确的用户。","invalid-channel":"请指定正确的频道。"},suggest:{hint:"您要找的是不是{0}？","command-prefix":"","command-suffix":"发送空行或句号以使用推测的指令。","help-prefix":"指令未找到。","help-suffix":"发送空行或句号以使用推测的指令。"},commands:{help:{description:"显示帮助信息",options:{help:"显示此信息",authority:"显示权限设置",showHidden:"查看隐藏的选项和指令"},messages:{"hint-authority":"括号内为对应的最低权限等级","hint-subcommand":"标有星号的表示含有子指令","command-aliases":"别名：{0}。","command-examples":"使用示例：","command-authority":"最低权限：{0} 级。","subcommand-prolog":"可用的子指令有{0}：","global-prolog":"当前可用的指令有{0}：","global-epilog":"输入“帮助 指令名”查看特定指令的语法和使用示例。","available-options":"可用的选项有：","available-options-with-authority":"可用的选项有（括号内为额外要求的权限等级）："}}}}});var $e=ve((wn,dt)=>{dt.exports={general:{name:"English",paren:" ({0}) ",quote:'"{0}"',comma:", ",and:"and",or:"or",day:"day",hour:"hour",minute:"minute",second:"second"},internal:{"low-authority":"Low authority.","insufficient-arguments":"Insufficient arguments, type help to see usage.","redunant-arguments":"Redunant arguments, type help to see usage.","invalid-argument":"Invalid argument {0}, {1}","unknown-option":"Unknown option {0}, type help to see usage.","invalid-option":"Invalid option {0}, {1}","check-syntax":"Type help to see usage.","invalid-number":"Expect a number.","invalid-integer":"Expect an integer.","invalid-posint":"Expect a positive integer.","invalid-natural":"Expect a non-negative integer.","invalid-date":"Expect a valid date.","invalid-user":"Expect a valid user.","invalid-channel":"Expect a valid channel."},suggest:{hint:"Do you mean {0}?","command-prefix":"","command-suffix":"Send a period to apply the suggestion.","help-prefix":"Command not found.","help-suffix":"Send a blank line or a period to apply the suggestion."},commands:{help:{description:"Show help",options:{help:"show this message",authority:"show authority requirements",showHidden:"show hidden options and commands"},messages:{"hint-authority":"this minimum authority is marked in parentheses","hint-subcommand":"those marked with an asterisk have subcommands","command-aliases":"Aliases: {0}.","command-examples":"Examples:","command-authority":"Minimal authority: {0}.","subcommand-prolog":"Available subcommands{0}:","global-prolog":"Available commands{0}:","global-epilog":'Type "help <command>" to see syntax and examples for a specific command.',"available-options":"Available options:","available-options-with-authority":"Available options (parentheses indicate additional authority requirement):"}}}}});export*from"@koishijs/utils";export*from"@koishijs/orm";import{Logger as ot,paramCase as at,remove as lt,Schema as U}from"@koishijs/utils";import{Logger as ke,makeArray as it,Random as st,sleep as rt}from"@koishijs/utils";import{coerce as Xe,Logger as Ye,remove as N,Schema as X}from"@koishijs/utils";import{camelCase as Ce,escapeRegExp as we,paramCase as Se,segment as se,Time as je}from"@koishijs/utils";var re=`"'“‘`,oe=`"'”’`,R;(function(w){let l={};function e(d,p,f){l[d]={terminator:p,parse:f}}w.interpolate=e,h(e,"interpolate"),e("$(",")");class t{constructor(){this.bracs=Object.create(l)}interpolate(p,f,m){this.bracs[p]={terminator:f,parse:m}}parseToken(p,f="$"){let m={inters:[]},y=re.indexOf(p[0]),A=oe[y],E="";A&&(p=p.slice(1),f=`${A}(?=${f})|$`),f+=`|${Object.keys({...this.bracs,...l}).map(we).join("|")}`;let b=new RegExp(f);for(;;){let S=b.exec(p);if(E+=p.slice(0,S.index),S[0]in this.bracs){p=p.slice(S.index+S[0].length).trimStart();let{parse:$,terminator:K}=this.bracs[S[0]],P=$?.(p)||this.parse(p,K);p=P.rest,m.inters.push({...P,pos:E.length,initiator:S[0]})}else{let $=S[0]===A,K=p.slice(S.index+ +$);return m.rest=K.trimStart(),m.quoted=$,m.terminator=S[0],$?m.terminator+=K.slice(0,-m.rest.length):A&&(E=re[y]+E,m.inters.forEach(P=>P.pos+=1)),m.content=E,A==="'"&&w.revert(m),m}}}parse(p,f=""){let m=[],y=p,A="",E=`\\s+|[${we(f)}]|$`;for(;y&&!(f&&y.startsWith(f));){let b=this.parseToken(y,E);m.push(b),y=b.rest,A=b.terminator,delete b.rest}return y.startsWith(f)&&(y=y.slice(1)),p=p.slice(0,-(y+A).length),{tokens:m,rest:y,source:p}}stringify(p){let f=p.tokens.reduce((m,y)=>(y.quoted&&(m+=re[oe.indexOf(y.terminator[0])]||""),m+y.content+y.terminator),"");return p.rest&&!oe.includes(f[f.length-1])||p.initiator?f.slice(0,-1):f}}h(t,"Tokenizer"),w.Tokenizer=t;let n=new t;function i(d,p=""){return n.parse(d,p)}w.parse=i,h(i,"parse");function s(d){return n.stringify(d)}w.stringify=s,h(s,"stringify");function r(d){for(;d.inters.length;){let{pos:p,source:f,initiator:m}=d.inters.pop();d.content=d.content.slice(0,p)+m+f+l[m].terminator+d.content.slice(p)}}w.revert=r,h(r,"revert");function a(d){return typeof d=="string"?c[d]||{}:{}}h(a,"resolveConfig");function o(d){return typeof d=="function"?d:d instanceof RegExp?p=>{if(d.test(p))return p;throw new Error}:Array.isArray(d)?p=>{if(d.includes(p))return p;throw new Error}:c[d]?.transform}h(o,"resolveType");let c={};function u(d,p,f){c[d]={...f,transform:p}}w.createDomain=u,h(u,"createDomain"),u("rawtext",d=>d),u("string",d=>d),u("text",d=>d,{greedy:!0}),u("rawtext",d=>se.unescape(d),{greedy:!0}),u("boolean",()=>!0),u("number",(d,p)=>{let f=+d;if(Number.isFinite(f))return f;throw new Error(p.text("internal.invalid-number"))}),u("integer",(d,p)=>{let f=+d;if(f*0==0&&Math.floor(f)===f)return f;throw new Error(p.text("internal.invalid-integer"))}),u("posint",(d,p)=>{let f=+d;if(f*0==0&&Math.floor(f)===f&&f>0)return f;throw new Error(p.text("internal.invalid-posint"))}),u("natural",(d,p)=>{let f=+d;if(f*0==0&&Math.floor(f)===f&&f>=0)return f;throw new Error(p.text("internal.invalid-natural"))}),u("date",(d,p)=>{let f=je.parseDate(d);if(+f)return f;throw new Error(p.text("internal.invalid-date"))}),u("user",(d,p)=>{if(d.startsWith("@"))return d=d.slice(1),d.includes(":")?d:`${p.platform}:${d}`;let f=se.from(d);if(f&&f.type==="at")return`${p.platform}:${f.data.id}`;throw new Error(p.text("internal.invalid-user"))}),u("channel",(d,p)=>{if(d.startsWith("#"))return d=d.slice(1),d.includes(":")?d:`${p.platform}:${d}`;let f=se.from(d);if(f&&f.type==="sharp")return`${p.platform}:${f.data.id}`;throw new Error(p.text("internal.invalid-channel"))});let g=/<[^>]+>|\[[^\]]+\]/g;function x(d){let p,f=[];for(;p=g.exec(d);){let m=p[0].slice(1,-1),y=!1;m.startsWith("...")&&(m=m.slice(3),y=!0);let[A,E]=m.split(":"),b=E?E.trim():void 0;f.push({name:A,variadic:y,type:b,required:p[0][0]==="<"})}return f.stripped=d.replace(/:[\w-]+[>\]]/g,m=>m.slice(-1)).trimEnd(),f}h(x,"parseDecl");function v(d,p,f,m,y={}){let{name:A,type:E,fallback:b}=y,S=d===""&&!p;if(S&&b!==void 0)return b;let $=o(E);if($)try{return $(d,m.session)}catch(P){if(!m.session)m.error=`internal.invalid-${f}`;else{let I=P.message||m.session.text("internal.check-syntax");m.error=m.session.text(`internal.invalid-${f}`,[A,I])}return}if(S)return!0;if(p)return d;let K=+d;return K*0==0?K:d}w.parseValue=v,h(v,"parseValue");class C{constructor(p,f,m){this.name=p;this.context=m;this._options={};this._namedOptions={};this._symbolicOptions={};if(!p)throw new Error("expect a command name");let y=this._arguments=x(f);this.declaration=y.stripped}_createOption(p,f,m){let y=Se(p),A=f.replace(/(?<=^|\s)[\w\x80-\uffff].*/,""),E=f.slice(A.length),b=A.replace(/(?<=^|\s)(<[^<]+>|\[[^[]+\]).*/,""),S=A.slice(b.length);b=b.trim()||"--"+y;let $=[],K=[];for(let k of b.trim().split(",")){k=k.trimStart();let F=k.replace(/^-+/,"");!F||!k.startsWith("-")?K.push(k):$.push(F)}!m.value&&!$.includes(y)&&(b+=", --"+y);let P=x(S);P.stripped&&(b+=" "+P.stripped);let I=this._options[p]||={...M.defaultOptionConfig,...P[0],...m,name:p,values:{},syntax:b};E&&this.context.i18n.define("",`commands.${this.name}.options.${p}`,E);let _=typeof I.fallback;"value"in m?$.forEach(k=>I.values[k]=m.value):S.trim()?!I.type&&(_==="string"||_==="number")&&(I.type=_):I.type="boolean",this._assignOption(I,$,this._namedOptions),this._assignOption(I,K,this._symbolicOptions),this._namedOptions[y]||(this._namedOptions[y]=I)}_assignOption(p,f,m){for(let y of f){if(y in m)throw new Error(`duplicate option name "${y}" for command "${this.name}"`);m[y]=p}}removeOption(p){if(!this._options[p])return!1;let f=this._options[p];delete this._options[p];for(let m in this._namedOptions)this._namedOptions[m]===f&&delete this._namedOptions[m];for(let m in this._symbolicOptions)this._symbolicOptions[m]===f&&delete this._symbolicOptions[m];return!0}parse(p,f,m=[],y={}){typeof p=="string"&&(p=w.parse(p,f));let A=this.name+" "+w.stringify(p);for(;!p.error&&p.tokens.length;){let E=p.tokens[0],{content:b,quoted:S}=E,$=this._arguments[m.length];if(b[0]!=="-"&&a($?.type).greedy){m.push(w.parseValue(w.stringify(p),!0,"argument",p,$));break}p.tokens.shift();let K,P,I;if(!S&&(K=this._symbolicOptions[b]))P=[Se(K.name)];else{if(b[0]!=="-"||S){m.push(w.parseValue(b,S,"argument",p,$||{type:"string"}));continue}let _=0,k;for(;_<b.length&&b.charCodeAt(_)===45;++_);if(b.slice(_,_+3)==="no-"&&!this._namedOptions[b.slice(_)]){k=b.slice(_+3),y[Ce(k)]=!1;continue}let F=_+1;for(;F<b.length&&b.charCodeAt(F)!==61;F++);k=b.slice(_,F),P=_>1?[k]:k,I=b.slice(++F),K=this._namedOptions[P[P.length-1]]}if(S=!1,!I){let{type:_}=K||{};if(a(_).greedy)I=w.stringify(p),S=!0,p.tokens=[];else if(_!=="boolean"&&p.tokens.length&&(_||p.tokens[0]?.content!=="-")){let k=p.tokens.shift();I=k.content,S=k.quoted}}for(let _=0;_<P.length;_++){let k=P[_],F=this._namedOptions[k],be=F?F.name:Ce(k);if(F&&k in F.values)y[be]=F.values[k];else{let De=_+1<P.length?"":I;y[be]=w.parseValue(De,S,"option",p,F)}if(p.error)break}}for(let{name:E,fallback:b}of Object.values(this._options))b!==void 0&&!(E in y)&&(y[E]=b);return delete p.tokens,{options:y,args:m,source:A,rest:p.rest,error:p.error||""}}stringifyArg(p){return p=""+p,p.includes(" ")?`"${p}"`:p}stringify(p,f){let m=this.name;for(let y in f){let A=f[y];A===!0?m+=` --${y}`:A===!1?m+=` --no-${y}`:m+=` --${y} ${this.stringifyArg(A)}`}for(let y of p)m+=" "+this.stringifyArg(y);return m}}h(C,"CommandBase"),w.CommandBase=C})(R||(R={}));import{defineProperty as Le,Logger as qe,makeArray as Ge,Random as He,remove as ee,sleep as We}from"@koishijs/utils";import{Driver as Re,Model as Be}from"@koishijs/orm";var Y;(function(t){let l;(function(i){i[i.ignore=1]="ignore"})(l=t.Flag||(t.Flag={})),t.fields=[]})(Y||(Y={}));var H;(function(t){let l;(function(s){s[s.ignore=1]="ignore",s[s.silent=4]="silent"})(l=t.Flag||(t.Flag={})),t.fields=[]})(H||(H={}));var J=class extends Be{constructor(e){super();this.ctx=e;this.extend("user",{id:"string(63)",name:"string(63)",flag:"unsigned(20)",authority:"unsigned(4)",locale:"string(63)"},{autoInc:!0}),this.extend("channel",{id:"string(63)",platform:"string(63)",flag:"unsigned(20)",assignee:"string(63)",guildId:"string(63)",locale:"string(63)"},{primary:["id","platform"]})}extend(e,t,n){super.extend(e,t,n),this.ctx.emit("model",e)}};h(J,"ModelService");var Z=class{constructor(e,t,n){this.ctx=e;this.name=t;this.immediate=n;O.service(t),e.on("ready",async()=>{await this.start(),e[t]=this}),e.on("dispose",async()=>{e[t]===this&&(e[t]=null),await this.stop()})}start(){}stop(){}get caller(){return this[O.current]||this.ctx}};h(Z,"Service");var V=class extends Re{constructor(e){super(e.model);this.ctx=e;e.on("ready",async()=>{await this.start(),e.database=this}),e.on("dispose",async()=>{e.database===this&&(e.database=null),await this.stop()})}start(){}stop(){}async getUser(e,t,n){let i=await this.get("user",{[e]:t},n);return Array.isArray(t)?i:(i[0]&&Object.assign(i[0],{[e]:t}),i[0])}setUser(e,t,n){return this.set("user",{[e]:t},n)}createUser(e,t,n){return this.create("user",{[e]:t,...n})}async getChannel(e,t,n){let i=await this.get("channel",{platform:e,id:t},n);return Array.isArray(t)?i:(i[0]&&Object.assign(i[0],{platform:e,id:t}),i[0])}async getAssignedChannels(e,t=this.ctx.getSelfIds()){return this.get("channel",{$or:Object.entries(t).map(([n,i])=>({platform:n,assignee:i}))},e)}setChannel(e,t,n){return this.set("channel",{platform:e,id:t},n)}createChannel(e,t,n){return this.create("channel",{platform:e,id:t,...n})}};h(V,"Database");(function(e){function l(t,n){let i=typeof t=="string"?Q.require(t):t;!i||(typeof n=="function"?n(i):Object.assign(i.prototype,n))}e.extend=l,h(l,"extend")})(V||(V={}));function Ne(l){return l?.default||l}h(Ne,"unwrapExports");var Q;(function(s){let l={};function e(r,a){l[r]=a}s.define=e,h(e,"define");let t;(function(c){function r(u){return l[u]}c.require=r,h(r,"require");function a(u){if(u in l)return u;throw new Error(`Cannot find module "${u}"`)}c.resolve=a,h(a,"resolve");function o(u){let g="koishi-plugin-",x="@koishijs/plugin-";if(u.includes(g)||u.startsWith(x))return[u];if(u[0]==="@"){let v=u.indexOf("/");return[u.slice(0,v+1)+g+u.slice(v+1)]}else return[g+u,x+u]}c.paths=o,h(o,"paths")})(t=s.internal||(s.internal={}));function n(r,a=!1){try{let o=i(r),c=t.require(o);return Ne(c)}catch(o){if(a)throw o}}s.require=n,h(n,"require");function i(r){let a=t.paths(r);for(let o of a)try{return t.resolve(o)}catch{}throw new Error(`cannot resolve plugin "${r}"`)}s.resolve=i,h(i,"resolve")})(Q||(Q={}));var D;(function(t){t.MAX_DEPTH=64;async function e(n,i){return typeof n=="function"?n(i):n}t.compose=e,h(e,"compose")})(D||(D={}));var te;(function(e){class l extends Map{resolve(n){return n&&(typeof n=="function"?n:n.apply)}get(n){return super.get(this.resolve(n))}set(n,i){return super.set(this.resolve(n),i)}has(n){return super.has(this.resolve(n))}delete(n){return super.delete(this.resolve(n))}}h(l,"Registry"),e.Registry=l})(te||(te={}));function _e(l){return l!==null&&l!==!1&&l!==void 0}h(_e,"isBailed");function ze(l){return!(!l.prototype||l.prototype.constructor!==l)}h(ze,"isConstructor");function Ve(l){return l&&typeof l=="object"&&typeof l.apply=="function"}h(Ve,"isApplicable");var Qe=["user","guild","channel","self","private","platform"],j=class{constructor(e,t,n=null){this.filter=e;this.app=t;this._plugin=n}[Symbol.for("nodejs.util.inspect.custom")](){return`Context <${this._plugin?this._plugin.name:"root"}>`}_property(e,...t){return this.intersect(n=>t.length?t.includes(n[e]):!!n[e])}user(...e){return this._property("userId",...e)}self(...e){return this._property("selfId",...e)}guild(...e){return this._property("guildId",...e)}channel(...e){return this._property("channelId",...e)}platform(...e){return this._property("platform",...e)}private(...e){return this.exclude(this._property("guildId"))._property("userId",...e)}select(e){let t=this;for(let n of Qe){let i=e[`$${n}`];i===!0?t=t[n]():i===!1?t=t.exclude(t[n]()):i!==void 0&&(t=t[n](...Ge(i).map(s=>""+s)))}if(e.$and)for(let n of e.$and)t=t.intersect(this.select(n));if(e.$or){let n=this.app;for(let i of e.$or)n=n.union(this.select(i));t=t.intersect(n)}return e.$not&&(t=t.exclude(this.select(e.$not))),t}logger(e){return new qe(e)}any(){return new j(()=>!0,this.app,this._plugin)}never(){return new j(()=>!1,this.app,this._plugin)}union(e){let t=typeof e=="function"?e:e.filter;return new j(n=>this.filter(n)||t(n),this.app,this._plugin)}intersect(e){let t=typeof e=="function"?e:e.filter;return new j(n=>this.filter(n)&&t(n),this.app,this._plugin)}exclude(e){let t=typeof e=="function"?e:e.filter;return new j(n=>this.filter(n)&&!t(n),this.app,this._plugin)}except(e){return this.exclude(e)}match(e){return!e||this.filter(e)}get state(){return this.app.registry.get(this._plugin)}using(e,t){return this.plugin({using:e,apply:t,name:t.name})}validate(e,t){if(t===!1)return;t===!0&&(t=void 0),t??={};let n=e.Config||e.schema;return n&&(t=n(t)),t}plugin(e,t){let n=typeof e=="string"?Q.require(e,!0):e;if(this.app.registry.has(n))return this.logger("app").warn(`duplicate plugin detected: ${n.name}`),this;if(typeof n!="function"&&!Ve(n))throw new Error('invalid plugin, expect function or object with an "apply" method');if(t=this.validate(n,t),!t)return this;let i=new j(this.filter,this.app,n).select(t),s=n.Config||n.schema,r=n.using||[];this.logger("app").debug("plugin:",n.name),this.app.registry.set(n,{plugin:n,schema:s,using:r,context:i,id:He.id(),parent:this,config:t,children:[],disposables:[]}),this.state.children.push(n),this.emit("plugin-added",this.app.registry.get(n)),r.length&&i.on("service",o=>{!r.includes(o)||(i.state.children.slice().map(c=>this.dispose(c)),i.state.disposables.slice(1).map(c=>c()),a())});let a=h(()=>{if(!r.some(o=>!this[o]))if(typeof n!="function")n.apply(i,t);else if(ze(n)){let o=new n(i,t);o instanceof Z&&o.immediate&&(i[o.name]=o)}else n(i,t)},"callback");return a(),this}dispose(e=this._plugin){if(!e)throw new Error("root level context cannot be disposed");let t=this.app.registry.get(e);if(!!t)return this.logger("app").debug("dispose:",e.name),t.children.slice().map(n=>this.dispose(n)),t.disposables.slice().map(n=>n()),this.app.registry.delete(e),ee(t.parent.state.children,e),this.emit("plugin-removed",t),t}*getHooks(e,t){let n=this.app._hooks[e]||[];for(let[i,s]of n.slice())!i.match(t)||(yield s)}async parallel(...e){let t=[],n=typeof e[0]=="object"?e.shift():null,i=e.shift();for(let s of this.getHooks(i,n))t.push(Promise.resolve(s.apply(n,e)).catch(r=>{this.logger("app").warn(r)}));await Promise.all(t)}emit(...e){this.parallel(...e)}async waterfall(...e){let t=typeof e[0]=="object"?e.shift():null,n=e.shift();for(let i of this.getHooks(n,t)){let s=await i.apply(t,e);e[0]=s}return e[0]}chain(...e){let t=typeof e[0]=="object"?e.shift():null,n=e.shift();for(let i of this.getHooks(n,t)){let s=i.apply(t,e);e[0]=s}return e[0]}async serial(...e){let t=typeof e[0]=="object"?e.shift():null,n=e.shift();for(let i of this.getHooks(n,t)){let s=await i.apply(t,e);if(_e(s))return s}}bail(...e){let t=typeof e[0]=="object"?e.shift():null,n=e.shift();for(let i of this.getHooks(n,t)){let s=i.apply(t,e);if(_e(s))return s}}on(e,t,n=!1){let i=n?"unshift":"push";if(typeof e=="string"&&e in j.deprecatedEvents){let a=j.deprecatedEvents[e];this.logger("app").warn(`event "${e}" is deprecated, use "${a}" instead`),e=a}if(e==="ready"&&this.app.isActive)return this.app._tasks.queue(We(0).then(()=>t())),()=>!1;if(e==="dispose")return this.state.disposables[i](t),()=>ee(this.state.disposables,t);let s=this.app._hooks[e]||=[];s.length>=this.app.options.maxListeners&&this.logger("app").warn('max listener count (%d) for event "%s" exceeded, which may be caused by a memory leak',this.app.options.maxListeners,e),s[i]([this,t]);let r=h(()=>(ee(this.state.disposables,r),this.off(e,t)),"dispose");return this.state.disposables.push(r),r}before(e,t,n=!1){let i=e.split("/");return i[i.length-1]="before-"+i[i.length-1],this.on(i.join("/"),t,!n)}once(e,t,n=!1){let i=this.on(e,function(...s){return i(),t.apply(this,s)},n);return i}off(e,t){let n=(this.app._hooks[e]||[]).findIndex(([i,s])=>i===this&&s===t);if(n>=0)return this.app._hooks[e].splice(n,1),!0}middleware(e,t=!1){return this.on(j.middleware,e,t)}createTimerDispose(e){let t=h(()=>{if(clearTimeout(e),!!this.state)return ee(this.state.disposables,t)},"dispose");return this.state.disposables.push(t),t}setTimeout(e,t,...n){let i=this.createTimerDispose(setTimeout(()=>{i(),e()},t,...n));return i}setInterval(e,t,...n){return this.createTimerDispose(setInterval(e,t,...n))}getCommand(e){return this.app._commands.get(e)}command(e,...t){let n=typeof t[0]=="string"?t.shift():"",i=t[0],s=e.split(" ",1)[0].toLowerCase(),r=e.slice(s.length),a=s.split(/(?=[./])/g),o,c,u=[];if(a.forEach((x,v)=>{let C=x.charCodeAt(0),w=C===46?o.name+x:C===47?x.slice(1):x,d=this.getCommand(w);if(d){if(o){if(d===o)throw new Error(`cannot set a command (${d.name}) as its own subcommand`);if(d.parent){if(d.parent!==o)throw new Error(`cannot create subcommand ${s}: ${d.parent.name}/${d.name} already exists`)}else d.parent=o,o.children.push(d)}return o=d}d=new M(w,r,this),u.push(d),c||(c=d),o&&(d.parent=o,d.config.authority=o.config.authority,o.children.push(d)),o=d}),n&&this.i18n.define("",`commands.${o.name}.description`,n),Object.assign(o.config,i),u.forEach(x=>this.emit("command-added",x)),!i?.patch)return c&&this.state.disposables.unshift(()=>c.dispose()),o;c&&c.dispose();let g=Object.create(o);return g._disposables=this.state.disposables,g}getSelfIds(e,t){if(e)return t||=this.bots.filter(i=>i.platform===e).map(i=>i.selfId),{[e]:t};let n={};for(let i of this.bots)(n[i.platform]||=[]).push(i.selfId);return n}async broadcast(...e){let t;Array.isArray(e[0])&&(t=e.shift());let[n,i]=e;if(!n)return[];let s=await this.database.getAssignedChannels(["id","assignee","flag","platform","guildId"]),r={};for(let{id:a,assignee:o,flag:c,platform:u,guildId:g}of s)t&&!t.includes(`${u}:${a}`)||!i&&c&H.Flag.silent||((r[u]||={})[o]||=[]).push([a,g]);return(await Promise.all(Object.entries(r).flatMap(([a,o])=>this.bots.map(c=>c.platform!==a?Promise.resolve([]):c.broadcast(o[c.selfId]||[],n))))).flat(1)}},O=j;h(O,"Context"),O.middleware=Symbol("middleware"),O.current=Symbol("source");(function(n){n.Services=[];function e(i){if(Object.prototype.hasOwnProperty.call(n.prototype,i))return;n.Services.push(i);let s=Symbol(i);Object.defineProperty(n.prototype,i,{get(){let r=this.app[s];if(!!r)return Le(r,n.current,this),r},set(r){let a=this.app[s];if(a===r)return;this.app[s]=r,this.emit("service",i);let o=r?a?"changed":"enabled":"disabled";this.logger("service").debug(i,o)}})}n.service=e,h(e,"service"),e("bots"),e("database"),e("i18n"),e("model"),n.deprecatedEvents={connect:"ready",disconnect:"dispose","before-command":"command/before-execute"}})(O||(O={}));var ae=new Ye("command"),le=class extends R.CommandBase{constructor(e,t,n){super(e,t,n);this.children=[];this.parent=null;this._aliases=[];this._examples=[];this._userFields=[["locale"]];this._channelFields=[["locale"]];this._actions=[];this._checkers=[async e=>this.app.serial(e.session,"command/before-execute",e)];this.config={...le.defaultConfig},this._registerAlias(e),n.app._commandList.push(this)}static userFields(e){return this._userFields.push(e),this}static channelFields(e){return this._channelFields.push(e),this}get app(){return this.context.app}get displayName(){return this._aliases[0]}set displayName(e){this._registerAlias(e,!0)}_registerAlias(e,t=!1){if(e=e.toLowerCase(),this._aliases.includes(e)){t&&(N(this._aliases,e),this._aliases.unshift(e));return}else t?this._aliases.unshift(e):this._aliases.push(e);let i=this.app.getCommand(e);if(!i)this.app._commands.set(e,this);else if(i!==this)throw new Error(`duplicate command names: "${e}"`);this._disposables?.push(()=>{N(this._aliases,e),this.app._commands.delete(e)})}[Symbol.for("nodejs.util.inspect.custom")](){return`Command <${this.name}>`}userFields(e){return this._userFields.push(e),this}channelFields(e){return this._channelFields.push(e),this}alias(...e){if(this._disposed)return this;for(let t of e)this._registerAlias(t);return this}shortcut(e,t={}){return this._disposed?this:(t.name=e,t.command=this,this.app._shortcuts.push(t),this._disposables?.push(()=>N(this.app._shortcuts,t)),this)}subcommand(e,...t){e=this.name+(e.charCodeAt(0)===46?"":"/")+e;let n=typeof t[0]=="string"?t.shift():"",i=t[0]||{};return this._disposed&&(i.patch=!0),this.context.command(e,n,i)}usage(e){return this._usage=e,this}example(e){return this._examples.push(e),this}option(e,t,n={}){return this._createOption(e,t,n),this._disposables?.push(()=>this.removeOption(e)),this}match(e){let{authority:t=1/0}=e.user||{};return this.context.match(e)&&this.config.authority<=t}getConfig(e,t){let n=this.config[e];return typeof n=="function"?n(t):n}check(e,t=!1){return this.before(e,t)}before(e,t=!1){return t?this._checkers.push(e):this._checkers.unshift(e),this._disposables?.push(()=>N(this._checkers,e)),this}action(e,t=!1){return t?this._actions.unshift(e):this._actions.push(e),this._disposables?.push(()=>N(this._actions,e)),this}use(e,...t){return e(this,...t)}async execute(e,t=D.compose){e.command??=this,e.args??=[],e.options??={};let{args:n,options:i,error:s}=e;if(s)return s;ae.level>=3&&ae.debug(e.source||=this.stringify(n,i));for(let c of this._checkers){let u=await c.call(this,e,...n);if(typeof u=="string")return u}if(!this._actions.length)return"";let r=0,a=this._actions.map(c=>async()=>await c.call(this,e,...n));a.push(t);let o=a.length;e.next=async c=>{if(c!==void 0&&(a.push(u=>D.compose(c,u)),a.length>D.MAX_DEPTH))throw new Error(`middleware stack exceeded ${D.MAX_DEPTH}`);return a[r++]?.(e.next)};try{let c=await e.next();if(typeof c=="string")return c}catch(c){if(r===o)throw c;let u=Xe(c);ae.warn(`${e.source||=this.stringify(n,i)}
${u}`),this.app.emit(e.session,"command-error",e,c)}return""}dispose(){this._disposed=!0,this.app.emit("command-removed",this);for(let e of this.children.slice())e.dispose();this.app._shortcuts=this.app._shortcuts.filter(e=>e.command!==this),this._aliases.forEach(e=>this.app._commands.delete(e)),N(this.app._commandList,this),this.parent&&N(this.parent.children,this)}},M=le;h(M,"Command"),M.defaultConfig={authority:1,showWarning:!0},M.defaultOptionConfig={authority:0},M._userFields=[],M._channelFields=[];(function(e){e.Config=X.object({authority:X.natural().default(1),hidden:X.boolean().default(!1),checkArgCount:X.boolean().default(!1),checkUnknown:X.boolean().default(!1)})})(M||(M={}));import{defineProperty as L,Logger as Je,makeArray as Ze,observe as ce,Random as et,remove as tt,segment as nt}from"@koishijs/utils";var pe=new Je("session"),W=class{constructor(e,t){Object.assign(this,t),this.platform=e.platform,L(this,"app",e.app),L(this,"bot",e),L(this,"user",null),L(this,"channel",null),L(this,"id",et.id()),L(this,"_queued",Promise.resolve()),L(this,"_hooks",[])}get uid(){return`${this.platform}:${this.userId}`}get gid(){return`${this.platform}:${this.guildId}`}get cid(){return`${this.platform}:${this.channelId}`}get sid(){return`${this.platform}:${this.selfId}`}toJSON(){return Object.fromEntries(Object.entries(this).filter(([e])=>!e.startsWith("_")&&!e.startsWith("$")))}async _preprocess(){let e,t=this.content.trim();return(e=nt.from(t,{type:"quote",caret:!0}))&&(t=t.slice(e.capture[0].length).trimStart(),this.quote=await this.bot.getMessage(e.data.channelId||this.channelId,e.data.id).catch(n=>{pe.warn(n)})),t}async preprocess(){return this._promise||=this._preprocess()}get username(){let e=this.user&&this.user.name?this.user.name:this.author?this.author.nickname||this.author.username:this.userId;return this.app.chain("appellation",e,this)}async send(e){if(!!e)return this.bot.sendMessage(this.channelId,e,this.guildId).catch(t=>(pe.warn(t),[]))}cancelQueued(e=this.app.options.delay.cancel){this._hooks.forEach(Reflect.apply),this._delay=e}async sendQueued(e,t){if(!!e){if(typeof t=="undefined"){let{message:n,character:i}=this.app.options.delay;t=Math.max(n,i*e.length)}return this._queued=this._queued.then(()=>new Promise(n=>{let i=h(()=>{n(),clearTimeout(s),tt(this._hooks,i)},"hook");this._hooks.push(i);let s=setTimeout(async()=>{await this.send(e),this._delay=t,i()},this._delay||0)}))}}resolveValue(e){return typeof e=="function"?Reflect.apply(e,null,[this]):e}async getChannel(e=this.channelId,t=[]){let{app:n,platform:i,guildId:s}=this;if(!t.length)return{platform:i,id:e,guildId:s};let r=await n.database.getChannel(i,e,t);if(r)return r;let a=await this.resolveValue(n.options.autoAssign)?this.selfId:"";if(a)return n.database.createChannel(i,e,{assignee:a,guildId:s});{let o=n.model.create("channel");return Object.assign(o,{platform:i,id:e,guildId:s}),o}}async _observeChannelLike(e,t=[]){let n=new Set(t),{platform:i}=this,s=`${i}:${e}`,r=this.app._channelCache.get(this.id,s);if(r){for(let o in r)n.delete(o);if(!n.size)return r}let a=await this.getChannel(e,[...n]);return r=this.app._channelCache.get(this.id,s),r?r.$merge(a):(r=ce(a,o=>this.app.database.setChannel(i,e,o),`channel ${s}`),this.app._channelCache.set(this.id,s,r)),r}async observeChannel(e=[]){let t=[this._observeChannelLike(this.channelId,e)];this.channelId!==this.guildId&&t.push(this._observeChannelLike(this.guildId,e));let[n,i=n]=await Promise.all(t);return this.guild=i,this.channel=n,n}async getUser(e=this.userId,t=[]){let{app:n,platform:i}=this;if(!t.length)return{[i]:e};let s=await n.database.getUser(i,e,t);if(s)return s;let r=await this.resolveValue(n.options.autoAuthorize);if(r)return n.database.createUser(i,e,{authority:r});{let a=n.model.create("user");return Object.assign(a,{[i]:e,authority:r}),a}}async observeUser(e=[]){let t=new Set(e),{userId:n,platform:i}=this,s=this.app._userCache.get(this.id,this.uid);if(s){for(let a in s)t.delete(a);if(!t.size)return this.user=s}if(this.author?.anonymous){let a=this.app.model.create("user");a[i]=n,a.authority=await this.resolveValue(this.app.options.autoAuthorize);let o=ce(a,()=>Promise.resolve());return this.user=o}let r=await this.getUser(n,[...t]);return s=this.app._userCache.get(this.id,this.uid),s?s.$merge(r):(s=ce(r,a=>this.app.database.setUser(this.platform,n,a),`user ${this.uid}`),this.app._userCache.set(this.id,this.uid,s)),this.user=s}async withScope(e,t){let n=this.scope;try{return this.scope=e,await t()}finally{this.scope=n}}text(e,t={}){let n=[this.app.options.locale];n.unshift(this.user?.locale),this.subtype==="group"&&(n.unshift(this.guild?.locale),n.unshift(this.channel?.locale));let i=Ze(e).map(s=>s.startsWith(".")?this.scope?this.scope+s:(this.app.logger("i18n").warn(new Error("missing scope")),""):s);return this.app.i18n.text(n,i,t)}collect(e,t,n=new Set){let i=h(s=>{if(s.session=this,s.tokens)for(let{inters:r}of s.tokens)r.forEach(i);!this.resolve(s)||(this.app.emit(s.session,`command/before-attach-${e}`,s,n),Ae(s,M[`_${e}Fields`],n),Ae(s,s.command[`_${e}Fields`],n))},"collect");return i(t),n}inferCommand(e){if(e.command)return e.command;if(e.name)return e.command=this.app._commands.resolve(e.name);let{parsed:t,subtype:n}=this;if(e.root&&n!=="private"&&t.prefix===null&&!t.appel||!e.tokens.length)return;let i=this.app._commands.resolve(e.tokens[0].content);if(i)return e.tokens.shift(),e.command=i}resolve(e){if(!!this.inferCommand(e)){if(e.tokens?.every(t=>!t.inters.length)){let{options:t,args:n,error:i}=e.command.parse(e);e.options={...e.options,...t},e.args=[...e.args||[],...n],e.error=i}return e.command}}async execute(e,t){if(typeof e=="string"&&(e=R.parse(e)),e.session=this,e.tokens){for(let s of e.tokens){let{inters:r}=s,a=[];for(let o=0;o<r.length;++o)a.push(await this.execute(r[o],!0));for(let o=r.length-1;o>=0;--o){let{pos:c}=r[o];s.content=s.content.slice(0,c)+a[o]+s.content.slice(c)}s.inters=[]}if(!this.resolve(e))return""}else if(e.command||=this.app.getCommand(e.name),!e.command)return pe.warn(new Error(`cannot find command ${e.name}`)),"";let{command:n}=e;if(!n.context.match(this))return"";this.app.database&&(this.subtype==="group"&&await this.observeChannel(this.collect("channel",e)),await this.observeUser(this.collect("user",e)));let i=!0;return t===!0&&(i=!1,t=void 0),this.withScope(`commands.${n.name}.messages`,async()=>{let s=await n.execute(e,t);return i?(await this.send(s),""):s})}middleware(e){let t=Te(this);return this.app.middleware(async(n,i)=>t&&Te(n)!==t?i():e(n,i),!0)}prompt(e=this.app.options.delay.prompt){return new Promise(t=>{let n=this.middleware(s=>{clearTimeout(i),n(),t(s.content)}),i=setTimeout(()=>{n(),t("")},e)})}};h(W,"Session");function Te(l){return""+l.userId+l.channelId}h(Te,"getSessionId");function Ae(l,e,t){for(let n of e){if(typeof n=="function"){n(l,t);continue}for(let i of n)t.add(i)}return t}h(Ae,"collectFields");var Ee=new ke("bot"),B=class{constructor(e,t){this.adapter=e;this.config=t;this.id=st.id();this.app=e.ctx.app,this.platform=t.platform||e.platform,this.logger=new ke(e.platform),this._status="offline",this.extendModel(),e.ctx.on("ready",()=>this.start()),e.ctx.on("dispose",()=>this.stop())}extendModel(){this.platform in this.app.model.config.user.fields||this.app.model.extend("user",{[this.platform]:{type:"string",length:63}},{unique:[this.platform]})}get status(){return this._status}set status(e){this._status=e,this.app.bots.includes(this)&&this.app.emit("bot-status-updated",this)}resolve(){this.status="online",Ee.success("logged in to %s as %c (%s)",this.platform,this.username,this.selfId)}reject(e){this.error=e,this.status="offline",Ee.error(e)}async start(){if(!this.config.disabled&&!["connect","reconnect","online"].includes(this.status)){this.status="connect";try{await this.app.parallel("bot-connect",this),await this.adapter.connect(this)}catch(e){this.reject(e)}}}async stop(){if(!["disconnect","offline"].includes(this.status)){this.status="disconnect";try{await this.app.parallel("bot-disconnect",this),await this.adapter.disconnect(this)}catch(e){this.logger.warn(e)}this.status="offline"}}get sid(){return`${this.platform}:${this.selfId}`}createSession(e){return new W(this,{...e,type:"send",selfId:this.selfId,platform:this.platform,timestamp:Date.now(),author:{userId:this.selfId,username:this.username,avatar:this.avatar,discriminator:this.discriminator,isBot:!0}})}async session(e){let t=this.createSession(e);if(!await this.app.serial(t,"before-send",t))return t}async getGuildMemberMap(e){let t=await this.getGuildMemberList(e);return Object.fromEntries(t.map(n=>[n.userId,n.nickname||n.username]))}async broadcast(e,t,n=this.app.options.delay.broadcast){let i=[];for(let s=0;s<e.length;s++){s&&n&&await rt(n);try{let[r,a]=it(e[s]);i.push(...await this.sendMessage(r,t,a))}catch(r){this.app.logger("bot").warn(r)}}return i}};h(B,"Bot");(function(e){e.library={}})(B||(B={}));var q=class{constructor(e,t){this.ctx=e;this.config=t;this.bots=[];e.on("ready",()=>this.start()),e.on("dispose",()=>this.stop())}connect(e){}disconnect(e){}dispatch(e){if(!this.ctx.app.isActive)return;let t=[e.type];e.subtype&&(t.unshift(t[0]+"/"+e.subtype),e.subsubtype&&t.unshift(t[0]+"/"+e.subsubtype));for(let n of t)this.ctx.emit(e,at(n),e)}};h(q,"Adapter");var ct=new ot("app");(function(r){r.redirect=Symbol("koishi.adapter.redirect"),r.library={},r.configMap={};function n(a,o){return o?`${a}.${o}`:a}r.join=n,h(n,"join");function i(a,o,...c){let u=a+"-adapter";a=a.toLowerCase(),B.library[a]=o;let g;if(typeof c[0]=="function")r.library[a]=c[0],g=c[0].schema;else{let w=function(d){if(d.type==="union"||d.type==="intersect")d.list.forEach(w);else if(d.type==="object")for(let p in d.dict)C.dict[p]=new U(d.dict[p]),C.dict[p].meta={...d.dict[p].meta,required:!1};else throw new Error("cannot flatten bot schema")};h(w,"flatten"),r.library[a]={[r.redirect]:c[1]},g=r.library[a].schema=U.union([]).description("机器人要使用的协议。");let C=U.object({protocol:U.string()});for(let d in c[0])r.library[n(a,d)]=c[0][d],w(c[0][d].schema),g.list.push(U.intersect([U.object({protocol:U.const(d).required()}),c[0][d].schema]).description(d));g.list.push(U.transform(C,d=>{if(d.protocol)throw new Error(`unknown protocol "${d.protocol}"`);return d.protocol=c[1](d),ct.debug("infer type as %s",d.protocol),d}))}let x=U.intersect([o.schema,U.union([U.object({bots:U.array(g).required().hidden()}),U.transform(g,C=>({bots:[C]}))])]);function v(C,w={}){C.emit("adapter",a),r.configMap[a]=w;for(let d of w.bots)C.bots.create(a,d,o)}return h(v,"apply"),{name:u,Config:x,apply:v}}r.define=i,h(i,"define");class s extends Array{constructor(o){super();this.app=o;this.adapters={}}get(o){return this.find(c=>c.sid===o)}create(o,c,u){u||=B.library[o];let g=this.resolve(o,c),x=new u(g,c);return g.bots.push(x),this.push(x),this.app.emit("bot-added",x),x}async remove(o){let c=this.findIndex(g=>g.id===o);if(c<0)return;let[u]=this.splice(c,1);return lt(u.adapter.bots,u),u.config.disabled=!0,this.app.emit("bot-removed",u),u.stop()}resolve(o,c){let u=n(o,c.protocol);if(this.adapters[u])return this.adapters[u];let g=r.library[u];if(!g)throw new Error(`unsupported protocol "${u}"`);if(g[r.redirect])return c.protocol=g[r.redirect](c),this.resolve(o,c);let x=new g(this[O.current],r.configMap[o]);return x.platform=o,this.adapters[u]=x}}h(s,"BotList"),r.BotList=s})(q||(q={}));import{coerce as vt,defineProperty as ne,escapeRegExp as Ct,Logger as wt,makeArray as St,Schema as T,Time as ge}from"@koishijs/utils";import{isNullable as Oe,Logger as ut,Time as ht}from"@koishijs/utils";var Ie=new ut("i18n"),z=class{constructor(e){this.ctx=e;this._data={};this._formatters={};this._renderers={};this.define("",{"":""}),this.define("zh",Pe()),this.define("en",$e());let{day:t,hour:n,minute:i,second:s}=ht;this.formatter("time",(r,a,o)=>{let c;return r>=t-n/2?(r+=n/2,c=Math.floor(r/t)+" "+this.text([o],["general.day"],{}),r%t>n&&(c+=` ${Math.floor(r%t/n)} `+this.text([o],["general.hour"],{}))):r>=n-i/2?(r+=i/2,c=Math.floor(r/n)+" "+this.text([o],["general.hour"],{}),r%n>i&&(c+=` ${Math.floor(r%n/i)} `+this.text([o],["general.minute"],{}))):r>=i-s/2?(r+=s/2,c=Math.floor(r/i)+" "+this.text([o],["general.minute"],{}),r%i>s&&(c+=` ${Math.floor(r%i/s)} `+this.text([o],["general.second"],{}))):c=Math.round(r/s)+" "+this.text([o],["general.second"],{}),c}),this.renderer("list",(r,a,o)=>{let c=a.map(u=>this.render(r.item,{value:u},o));return r.header&&c.unshift(this.render(r.header,a,o)),r.footer&&c.push(this.render(r.footer,a,o)),c.join(`
`)}),this.renderer("inline-list",(r,a,o)=>{let c="";a.forEach((g,x)=>{x&&(x===a.length-1&&r.conj!==void 0?c+=r.conj:c+=r.separator??this.text([o],["general.comma"],{})),c+=this.render(r.item,{value:g},o)??g});let u=a.length in r?a.length:"body";return r[u]===void 0?c:this.render(r[u],[c,a.length],o)})}static isTemplate(e){return typeof e=="string"||e?.$}set(e,t,n){if(z.isTemplate(n)){let i=this._data[e],s=t.slice(0,-1);!Oe(i[s])&&!e.startsWith("$")&&Ie.warn("override",e,s),i[s]=n,this[O.current]?.on("dispose",()=>{delete i[s]})}else if(n)for(let i in n)this.set(e,t+i+".",n[i])}define(e,...t){this._data[e]||={},typeof t[0]=="string"?this.set(e,t[0]+".",t[1]):this.set(e,"",t[0])}formatter(e,t){this._formatters[e]=t}renderer(e,t){this._renderers[e]=t}render(e,t,n){if(e!==void 0){if(typeof e!="string"){let i=this._renderers[e.$];if(!i)throw new Error(`Renderer "${e.$}" not found`);return i(e,t,n)}return e.replace(/\{(.+?)\}/g,(i,s)=>{let[r,...a]=s.split("|"),o=r.trim().split("."),c=t;for(let u of o)if(c=c[u],Oe(c))return"";for(let u of a){let g=u.trim().match(/(\w+)(?:\((.+)\))?/),x=this._formatters[g[1]];if(!x)throw new Error(`Formatter "${g[1]}" not found`);let v=g[2]?g[2].split(",").map(C=>C.trim()):[];c=x(c,v,n)}return c.toString()})}}text(e,t,n){let i=new Set;for(let s of e)!s||i.add(s);for(let s in this._data)s.startsWith("$")||i.add(s);for(let s of t)for(let r of i)for(let a of["$"+r,r]){let o=this._data[a]?.[s];if(o!==void 0)return this.render(o,n,r)}return Ie.warn("missing",t[0]),t[0]}};h(z,"I18n");import{defineProperty as ft,valueMap as mt}from"@koishijs/utils";function de(l){l.before("parse",(t,n)=>{let i=R.parse(t);return n.quote&&i.tokens.push({content:n.quote.content,quoted:!0,inters:[],terminator:""}),i}),l.before("parse",(t,n)=>{let{parsed:i,quote:s}=n;if(!(i.prefix||s))for(let r of l.app._shortcuts){let{name:a,fuzzy:o,command:c,prefix:u,options:g={},args:x=[]}=r;if(!(u&&!i.appel||!c.context.match(n)))if(typeof a=="string"){if(!o&&t!==a||!t.startsWith(a))continue;let v=t.slice(a.length);if(o&&!i.appel&&v.match(/^\S/))continue;let C=c.parse(v.trim(),"",[...x],{...g});return C.command=c,C}else{let C=function(w){return typeof w!="string"?w:(w=w.replace(/\$\$/g,"@@__PLACEHOLDER__@@"),v.forEach((d,p)=>{!p||p>9||(w=w.replace(new RegExp(`\\$${p}`,"g"),(d||"").replace(/\$/g,"@@__PLACEHOLDER__@@")))}),w.replace(/@@__PLACEHOLDER__@@/g,"$"))};h(C,"escape");let v=a.exec(t);if(!v)continue;return{command:c,args:x.map(C),options:mt(g,C)}}}}),l.before("attach",t=>{ft(t,"argv",l.bail("before-parse",t.parsed.content,t)),t.argv.root=!0,t.argv.session=t}),l.middleware((t,n)=>t.resolve(t.argv)?t.execute(t.argv,n):n());function e(t,n){if(!!l.getCommand("help"))return t.execute({name:"help",args:[n]})}h(e,"executeHelp"),l.before("command/execute",t=>{let{args:n,command:i,options:s,session:r}=t;if(s.help&&i._options.help)return e(r,i.name);if(i._actions.length)return;let a=n.shift()||"",o=l.getCommand(i.name+"."+a);return o?r.execute({...t,command:o}):e(r,i.name)})}h(de,"runtime");function ue(l){l.on("command-added",e=>{e.userFields(({tokens:t,command:n,options:i={}},s)=>{if(!n)return;let{authority:r}=n.config,a=r>0;for(let{name:o,authority:c}of Object.values(n._options))o in i?c>0&&(a=!0):t&&c>0&&(a=!0);a&&s.add("authority")})}),l.before("command/execute",e=>{let{session:t,options:n,command:i}=e;if(!t.user)return;function s(r,...a){return i.config.showWarning?t.text(r,a):""}if(h(s,"sendHint"),t.user.authority&&i.getConfig("authority",t)>t.user.authority)return s("internal.low-authority");for(let r of Object.values(i._options))if(r.name in n&&r.authority>t.user.authority)return s("internal.low-authority")}),l.before("command/execute",e=>{let{args:t,options:n,command:i,session:s}=e;function r(a,...o){return i.config.showWarning?s.text(a,o):""}if(h(r,"sendHint"),i.config.checkArgCount){if((i._arguments[t.length]||{}).required)return r("internal.insufficient-arguments");let o=i._arguments[i._arguments.length-1]||{};if(t.length>i._arguments.length&&o.type!=="text"&&!o.variadic)return r("internal.redunant-arguments")}if(i.config.checkUnknown){let a=Object.keys(n).filter(o=>!i._options[o]);if(a.length)return r("internal.unknown-option",a.join(", "))}})}h(ue,"validate");import{distance as bt}from"fastest-levenshtein";function gt(l){return l.option("help","-h",{hidden:!0,descPath:"commands.help.options.help"})}h(gt,"enableHelp");function he(l,e={}){e.options!==!1&&l.on("command-added",r=>r.use(gt));let t=l.app;function n(r){let a=t._commands.resolve(r);if(a)return a;let o=t._shortcuts.find(({name:c})=>typeof c=="string"?c===r:c.test(r));if(o)return o.command}h(n,"findCommand");let i=h(r=>(a,o)=>{let{args:[c],session:u}=a,g=n(c);!g||u.collect(r,{...a,command:g,args:[],options:{help:!0}},o)},"createCollector"),s=l.command("help [command:string]",{authority:0,...e}).userFields(["authority"]).userFields(i("user")).channelFields(i("channel")).option("authority","-a").option("showHidden","-H").action(async({session:r,options:a},o)=>{if(!o){let u=t._commandList.filter(v=>v.parent===null),g=Fe(".global-prolog",r,u,a),x=r.text(".global-epilog");return x&&g.push(x),g.filter(Boolean).join(`
`)}let c=n(o);return c?.context.match(r)?Me(c,r,a):r.suggest({target:o,items:fe(r),prefix:r.text("suggest.help-prefix"),suffix:r.text("suggest.help-suffix"),async apply(u){return Me(l.getCommand(u),this,a)}})});e.shortcut!==!1&&s.shortcut("帮助",{fuzzy:!0})}h(he,"help");function fe(l){return l.app._commandList.filter(e=>e.match(l)&&!e.config.hidden).flatMap(e=>e._aliases)}h(fe,"getCommandNames");function*Ke(l,e,t=!1){for(let n of e)!t&&n.config.hidden||(n.match(l)?yield n:yield*Ke(l,n.children,t))}h(Ke,"getCommands");function Fe(l,e,t,n){let i=Array.from(Ke(e,t,n.showHidden)).sort((c,u)=>c.displayName>u.displayName?1:-1);if(!i.length)return[];let s=!1,r=i.map(({name:c,displayName:u,config:g,children:x})=>{let v="    "+u;return n.authority&&(v+=` (${g.authority}${x.length?(s=!0,"*"):""})`),v+="  "+e.text([`commands.${c}.description`,""]),v}),a=[];n.authority&&a.push(e.text(".hint-authority")),s&&a.push(e.text(".hint-subcommand"));let o=a.length?e.text("general.paren",[a.join(e.text("general.comma"))]):"";return r.unshift(e.text(l,[o])),r}h(Fe,"formatCommands");function yt(l,e){return e.user&&l.authority>e.user.authority?!1:!e.resolveValue(l.hidden)}h(yt,"getOptionVisibility");function xt(l,e,t){if(l.config.hideOptions&&!t.showHidden)return[];let n=t.showHidden?Object.values(l._options):Object.values(l._options).filter(s=>yt(s,e));if(!n.length)return[];let i=t.authority&&n.some(s=>s.authority)?[e.text(".available-options-with-authority")]:[e.text(".available-options")];return n.forEach(s=>{let a=`${s.authority&&t.authority?`(${s.authority}) `:""}${s.syntax}`,o=e.text(s.descPath??[`commands.${l.name}.options.${s.name}`,""]);o&&(a+="  "+o),a=l.app.chain("help/option",a,s,l,e),i.push("    "+a)}),i}h(xt,"getOptions");async function Me(l,e,t){let n=[l.displayName+l.declaration],i=e.text([`commands.${l.name}.description`,""]);if(i&&n.push(i),e.app.database){let s={command:l,args:[],options:{help:!0}},r=e.collect("user",s);if(await e.observeUser(r),e.subtype==="group"){let a=e.collect("channel",s);await e.observeChannel(a)}}if(l._aliases.length>1&&n.push(e.text(".command-aliases",[Array.from(l._aliases.slice(1)).join("，")])),e.app.emit(e,"help/command",n,l,e),e.user&&l.config.authority>1&&n.push(e.text(".command-authority",[l.config.authority])),l._usage)n.push(typeof l._usage=="string"?l._usage:await l._usage(e));else{let s=e.text([`commands.${l.name}.usage`,""]);s&&n.push(s)}if(n.push(...xt(l,e,t)),l._examples.length)n.push(e.text(".command-examples"),...l._examples.map(s=>"    "+s));else{let s=e.text([`commands.${l.name}.examples`,""]);s&&n.push(...s.split(`
`).map(r=>"    "+r))}return n.push(...Fe(".subcommand-prolog",e,l.children,t)),n.filter(Boolean).join(`
`)}h(Me,"showHelp");W.prototype.suggest=h(function(e){let{target:t,items:n,prefix:i="",suffix:s,apply:r,next:a=D.compose,minSimilarity:o=this.app.options.minSimilarity}=e,c=h(async v=>{let C=await a(v);C&&await this.send(C)},"sendNext"),u,g=1/0;for(let v of n){let C=bt(v,t);v.length<=2||C>v.length*o||(C===g?u.push(v):C<g&&(u=[v],g=C))}if(!u)return c(async()=>i);let x=this.scope;return c(async()=>{let v=i+this.text("suggest.hint",[u.map(w=>this.text("general.quote",[w])).join(this.text("general.or"))]);if(u.length>1)return v;let C=this.middleware((w,d)=>{C();let p=w.content.trim();return p&&p!=="."&&p!=="。"?d():w.withScope(x,()=>r.call(w,u[0],d))});return v+s})},"suggest");function me(l){l.middleware((e,t)=>{let{argv:n,quote:i,subtype:s,parsed:{content:r,prefix:a,appel:o}}=e;if(n.command||s!=="private"&&!a&&!o)return t();let c=r.split(/\s/,1)[0].toLowerCase();return c?e.suggest({target:c,next:t,items:fe(e),prefix:e.text("suggest.command-prefix"),suffix:e.text("suggest.command-suffix"),async apply(u,g){let x=u+r.slice(c.length)+(i?" "+i.content:"");return this.execute(x,g)}}):t()})}h(me,"suggest");function _t(l,e="",t=""){return l.length?new RegExp(`^${e}(${l.map(Ct).join("|")})${t}`):/$^/}h(_t,"createLeadingRE");var ye=new wt("app"),G=class extends O{constructor(e={}){super(()=>!0);this._commandList=[];this._commands=new Map;this._shortcuts=[];this._tasks=new xe;this._hooks={};this._sessions=Object.create(null);this._userCache=new ie;this._channelCache=new ie;this.app=this;this.isActive=!1;this.registry=new te.Registry;this.options=new G.Config(e),this.registry.set(null,{id:"",parent:null,using:[],children:[],disposables:[]}),this.model=new J(this),this.i18n=new z(this),this.bots=new q.BotList(this),this._commands.resolve=t=>{if(!t)return;let n=t.split("."),i=1,s=n[0],r;for(;(r=this.getCommand(s))&&i<n.length;)s=r.name+"."+n[i++];return r},this.prepare(),this.middleware(this._process.bind(this)),this.on("message",this._handleMessage.bind(this)),this.before("attach-user",(t,n)=>{t.collect("user",t.argv,n)}),this.before("attach-channel",(t,n)=>{t.collect("channel",t.argv,n)}),this.plugin(de),this.plugin(ue),this.plugin(me),this.plugin(he,e.help)}prepare(){let{nickname:e}=this.options;this.options.nickname=St(e),this._nameRE=_t(this.options.nickname,"@?","([,，]\\s*|\\s+)")}async start(){this.isActive=!0,ye.debug("started");for(let e of this.getHooks("ready"))this._tasks.queue(e());delete this._hooks.ready,await this._tasks.flush()}async stop(){this.isActive=!1,ye.debug("stopped"),await Promise.all(this.state.disposables.map(e=>e()))}_resolvePrefixes(e){let t=e.resolveValue(this.options.prefix);return Array.isArray(t)?t:[t||""]}async _process(e,t){let n,i=!1,s=!1,r=null,a=/^\[CQ:(\w+)((,\w+=[^,\]]*)*)\]/,o=await e.preprocess();e.subtype!=="private"&&(n=o.match(a))&&n[1]==="at"&&n[2].includes("id="+e.selfId)?(i=s=!0,o=o.slice(n[0].length).trimStart()):(n=o.match(this._nameRE))&&(s=!0,o=o.slice(n[0].length));for(let c of this._resolvePrefixes(e))!o.startsWith(c)||(r=c,o=o.slice(c.length));if(ne(e,"parsed",{content:o,appel:s,prefix:r}),this.emit(e,"before-attach",e),this.database){if(e.subtype==="group"){let g=new Set(["flag","assignee","guildId","locale"]);this.emit("before-attach-channel",e,g);let x=await e.observeChannel(g);if(x.guildId=e.guildId,await this.serial(e,"attach-channel",e)||x.flag&H.Flag.ignore||x.assignee!==e.selfId&&!i)return}let c=new Set(["flag","authority","locale"]);this.emit("before-attach-user",e,c);let u=await e.observeUser(c);if(await this.serial(e,"attach-user",e)||u.flag&Y.Flag.ignore)return}return this.emit(e,"attach",e),t()}async _handleMessage(e){this._sessions[e.id]=e;let t=this._hooks[O.middleware].filter(([o])=>o.match(e)).map(([,o])=>o.bind(null,e)),n=0,i="",s="",{prettyErrors:r}=this.options,a=h(async o=>{if(r&&(s=new Error().stack.split(`
`,3)[2],n)){let c=s.match(/\((.+)\)/);i=`
  - ${c?c[1]:s.slice(7)}${i}`}try{if(!this._sessions[e.id])throw new Error("isolated next function detected");if(o!==void 0&&(t.push(c=>D.compose(o,c)),t.length>D.MAX_DEPTH))throw new Error(`middleware stack exceeded ${D.MAX_DEPTH}`);return await t[n++]?.(a)}catch(c){let u=vt(c);if(r){let g=u.indexOf(s);g>=0?u=u.slice(0,g):u+=`
`,u+=`Middleware stack:${i}`}this.logger("session").warn(`${e.content}
${u}`)}},"next");try{let o=await a();o&&await e.send(o)}finally{delete this._sessions[e.id],this.emit(e,"middleware",e),this._userCache.delete(e.id),this._channelCache.delete(e.id),await e.user?.$update(),await e.channel?.$update(),await e.guild?.$update()}}};h(G,"App");(function(e){e.Config=T.intersect([]),ne(e.Config,"Basic",T.object({locale:T.string().default("zh").description("默认使用的语言。"),prefix:T.union([T.array(String),T.transform(String,t=>[t])]).default([""]).description("指令前缀字符，可以是字符串或字符串数组。将用于指令前缀的匹配。"),nickname:T.union([T.array(String),T.transform(String,t=>[t])]).description("机器人的昵称，可以是字符串或字符串数组。将用于指令前缀的匹配。"),autoAssign:T.union([Boolean,Function]).default(!0).description("当获取不到频道数据时，是否使用接受者作为代理者。"),autoAuthorize:T.union([T.natural(),Function]).default(1).description("当获取不到用户数据时默认使用的权限等级。"),minSimilarity:T.percent().default(.4).description("用于模糊匹配的相似系数，应该是一个 0 到 1 之间的数值。数值越高，模糊匹配越严格。设置为 1 可以完全禁用模糊匹配。")}).description("基础设置")),ne(e.Config,"Features",T.object({delay:T.object({character:T.natural().role("ms").default(0).description("调用 `session.sendQueued()` 时消息间发送的最小延迟，按前一条消息的字数计算。"),message:T.natural().role("ms").default(.1*ge.second).description("调用 `session.sendQueued()` 时消息间发送的最小延迟，按固定值计算。"),cancel:T.natural().role("ms").default(0).description("调用 `session.cancelQueued()` 时默认的延迟。"),broadcast:T.natural().role("ms").default(.5*ge.second).description("调用 `bot.broadcast()` 时默认的延迟。"),prompt:T.natural().role("ms").default(ge.minute).description("调用 `session.prompt()` 时默认的等待时间。")})}).description("消息设置")),ne(e.Config,"Advanced",T.object({prettyErrors:T.boolean().default(!0).description("启用报错优化模式。在此模式下 Koishi 会对程序抛出的异常进行整理，过滤掉框架内部的调用记录，输出更易读的提示信息。"),maxListeners:T.natural().default(64).description("每种监听器的最大数量。如果超过这个数量，Koishi 会认定为发生了内存泄漏，将产生一个警告。")}).description("高级设置")),e.Config.list.push(e.Config.Basic,e.Config.Features,e.Config.Advanced)})(G||(G={}));function Yn(l){return l}h(Yn,"defineConfig");var xe=class{#e=new Set;queue(e){let t=Promise.resolve(e).catch(n=>ye.warn(n)).then(()=>this.#e.delete(t));this.#e.add(t)}async flush(){for(;this.#e.size;)await Promise.all(Array.from(this.#e))}};h(xe,"TaskQueue");var ie=class{#e=Object.create(null);get(e,t){let n=this.#e[t];if(!!n)return n.refs.add(e),n.value}set(e,t,n){(this.#e[t]||={value:n,key:t,refs:new Set}).refs.add(e)}delete(e){for(let t in this.#e){let{refs:n}=this.#e[t];n.delete(e),n.size||delete this.#e[t]}}};h(ie,"SharedCache");var si="4.5.1";export{q as Adapter,G as App,R as Argv,B as Bot,H as Channel,M as Command,O as Context,V as Database,J as ModelService,Q as Modules,D as Next,te as Plugin,Z as Service,W as Session,ie as SharedCache,Y as User,Yn as defineConfig,gt as enableHelp,fe as getCommandNames,Te as getSessionId,Ne as unwrapExports,si as version};
